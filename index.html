<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FairKass — Веб-касса</title>

<!-- Firebase compat SDK (Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#FFF8F0;
    --card:#fff;
    --accent:#FFDDAA;
    --accent-strong:#FFD699;
    --orange:#D2691E;
    --green:#2E7D32;
    --red:#B71C1C;
    --shadow: 0 6px 18px rgba(0,0,0,0.06);
    --radius:12px;
    --mono: "Segoe UI", Roboto, Arial, sans-serif;
    --gap:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:var(--mono);background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
  .app {max-width:980px;margin:10px auto;padding:12px;}

  header {display:flex;align-items:center;gap:12px;padding:8px 4px}
  .logo {width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#fff 0,#FFEFD5 80%);display:flex;align-items:center;justify-content:center;font-weight:700;color:#333;box-shadow:var(--shadow);flex:0 0 48px}
  h1{font-size:18px;margin:0}

  .toolbar{display:flex;align-items:center;justify-content:space-between;margin-top:8px;gap:8px;flex-wrap:wrap}
  .toolbar .left{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .btn{
    background:#fff;border:1px solid rgba(0,0,0,0.06);padding:10px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow);font-weight:600;
    min-height:44px; /* touch target */
  }
  .btn.secondary{background:transparent}
  .status-badge{padding:6px 10px;border-radius:999px;font-weight:600;display:inline-block}

  .list {margin-top:12px;display:flex;flex-direction:column;gap:12px;min-height:240px;padding-bottom:12px}

  .card{
    background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;
  }
  .row-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .left-info{flex:1;display:flex;flex-direction:column;min-width:0}
  .terminal{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .amount{font-size:18px;font-weight:700}
  .items{color:#444;font-size:13px;margin-top:4px;word-break:break-word}

  .card.pending{background:linear-gradient(180deg,#FFF8EA 0,#FFF3D6 100%)}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px;flex-wrap:wrap}

  footer{margin-top:14px;padding:10px;border-radius:10px;background:#FFF0C2;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:40;padding:20px}
  .modal{width:100%;max-width:720px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 30px 80px rgba(0,0,0,0.35);max-height:calc(100vh - 80px);overflow:auto}
  .modal h2{margin:0 0 8px 0}
  .modal .meta{color:#666;font-size:13px;margin-bottom:12px}
  .modal .positions{font-family:monospace;background:#f7f7f7;padding:10px;border-radius:8px;max-height:320px;overflow:auto}
  .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}

  /* terminal bind controls */
  .bind-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .bind-row input[type="text"]{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);min-width:140px}
  .small-note{font-size:13px;color:#666}

  /* responsive mobile improvements */
  @media (max-width:600px){
    .app{padding:10px}
    header{gap:10px}
    h1{font-size:16px}
    .toolbar{flex-direction:column;align-items:stretch}
    .toolbar .left{width:100%;justify-content:space-between}
    .btn{flex:1}
    .row-top{align-items:flex-start}
    .amount{font-size:16px}
    .actions{flex-direction:column;align-items:stretch}
    .modal{padding:14px;border-radius:10px}
    .modal-backdrop{padding:8px}
    .items{font-size:14px}
  }

  /* empty state */
  .empty {
    background:linear-gradient(180deg,#fff 0,#fff 100%);
    border: 1px dashed rgba(0,0,0,0.06);
    padding:20px;border-radius:12px;text-align:center;color:#666
  }

  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo">FK</div>
    <div style="flex:1;min-width:0">
      <h1>FairKass — Кассир (веб)</h1>
      <div class="muted">Realtime DB: <span id="serverStatus">...подключение...</span></div>
    </div>
  </header>

  <div class="toolbar" role="toolbar">
    <div class="left" style="align-items:center">
      <div class="bind-row" style="gap:8px">
        <label for="terminalInput" class="small-note">ID терминала:</label>
        <input id="terminalInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="только цифры" aria-label="ID терминала" />
        <button class="btn" id="btnBind">Привязать</button>
        <button class="btn secondary" id="btnUnbind">Отвязать</button>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <span id="newCount" class="status-badge" style="background:#fff;border:1px solid rgba(0,0,0,0.06)">Новых: 0</span>
      <span style="font-size:13px;color:#666">Режим: <strong id="modeLabel">FIREBASE</strong></span>
    </div>
  </div>

  <main>
    <div id="list" class="list" aria-live="polite"></div>
    <div id="emptyNotice" style="margin-top:12px"></div>
  </main>

  <footer>
    <div class="muted">База: <span id="dbInfo">paymentAttempts</span></div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn secondary" id="btnClear">Очистить отображение</button>
      <button class="btn secondary" id="btnReload">Жёсткая перезагрузка</button>
    </div>
  </footer>
</div>

<!-- Modal root -->
<div id="modalRoot" style="display:none;"></div>

<script>
/*
  Полный файл: только Firebase (mock удалён).
  Добавлена привязка терминала (цифры), сохранение в localStorage,
  фильтрация операций по привязанному терминалу, сообщения об отсутствии данных.
*/

// --- Вставьте сюда вашу конфигурацию Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyABvY_6cHonbLvdBj5cYMSheJDLMd_-bNw",
  authDomain: "app-fairpay.firebaseapp.com",
  databaseURL: "https://app-fairpay-default-rtdb.firebaseio.com",
  projectId: "app-fairpay",
  storageBucket: "app-fairpay.firebasestorage.app",
  messagingSenderId: "29576302334",
  appId: "1:29576302334:web:0e559f804bf62c59981faf"
};

// constants
const LS_KEY = 'fk_bound_terminal';

// UI elements
const listEl = document.getElementById('list');
const newCountEl = document.getElementById('newCount');
const serverStatusEl = document.getElementById('serverStatus');
const terminalInput = document.getElementById('terminalInput');
const btnBind = document.getElementById('btnBind');
const btnUnbind = document.getElementById('btnUnbind');
const emptyNotice = document.getElementById('emptyNotice');
const btnClear = document.getElementById('btnClear');
const btnReload = document.getElementById('btnReload');

let boundTerminal = null;
let ops = new Map();
let dbRef = null;

function formatMoney(n){ return (+n || 0).toFixed(2) + ' ₽'; }
function formatTime(ts){ return new Date(ts || Date.now()).toLocaleString(); }

function sanitizeTerminalInput(v){
  if(!v) return null;
  const digits = v.toString().replace(/\D+/g,'');
  return digits || null;
}

function saveBoundTerminal(id){
  if(id) localStorage.setItem(LS_KEY, id); else localStorage.removeItem(LS_KEY);
}

function loadBoundTerminal(){
  const v = localStorage.getItem(LS_KEY);
  return sanitizeTerminalInput(v);
}

function setBoundTerminal(id){
  boundTerminal = id;
  if(boundTerminal){
    terminalInput.value = boundTerminal;
    saveBoundTerminal(boundTerminal);
    showToast('Терминал привязан: ' + boundTerminal);
  } else {
    terminalInput.value = '';
    saveBoundTerminal(null);
    showToast('Терминал отвязан');
  }
  renderList(); // apply filter
}

btnBind.addEventListener('click', ()=> {
  const raw = terminalInput.value;
  const id = sanitizeTerminalInput(raw);
  if(!id){
    alert('Введите корректный ID терминала (только цифры).');
    return;
  }
  setBoundTerminal(id);
});

btnUnbind.addEventListener('click', ()=> {
  setBoundTerminal(null);
});

// clear view (does not touch DB)
btnClear.addEventListener('click', ()=> {
  ops.clear(); renderList();
  showToast('Отображение очищено (данные в БД нетронуты)');
});

// hard reload
btnReload.addEventListener('click', ()=> {
  fetch(window.location.href, {cache: 'reload', mode: 'no-cors'}).finally(()=> location.reload());
});

// build card
function buildCard(op){
  const card = document.createElement('div');
  card.className = 'card' + (op.status === 'pending' ? ' pending' : '');

  const top = document.createElement('div'); top.className = 'row-top';
  const left = document.createElement('div'); left.className = 'left-info';
  const term = document.createElement('div'); term.className = 'terminal'; term.textContent = op.terminalId || 'TERM';
  const amount = document.createElement('div'); amount.className = 'amount'; amount.textContent = formatMoney(op.amount || 0);
  left.appendChild(term); left.appendChild(amount);

  const statusWrap = document.createElement('div'); statusWrap.style.minWidth = '96px'; statusWrap.style.textAlign='right';
  const st = document.createElement('div'); st.textContent = (op.status||'pending').toUpperCase(); st.className='status-badge';
  if(op.status === 'pending'){ st.style.background = 'var(--accent-strong)'; st.style.color = 'var(--orange)'; }
  else if(op.status === 'confirmed'){ st.style.background = '#E8F5E9'; st.style.color = 'var(--green)'; }
  else { st.style.background = '#FFEBEE'; st.style.color='var(--red)'; }
  statusWrap.appendChild(st);

  top.appendChild(left); top.appendChild(statusWrap);
  card.appendChild(top);

  const itemsSummary = document.createElement('div'); itemsSummary.className='items';
  if(op.items && op.items.length){
    itemsSummary.textContent = op.items.map(i => `${i.name} x${i.count}`).join('; ');
  } else {
    itemsSummary.textContent = '—';
  }
  card.appendChild(itemsSummary);

  const actions = document.createElement('div'); actions.className='actions';
  const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Просмотр';
  viewBtn.onclick = ()=> showModal(op);
  const accept = document.createElement('button'); accept.className='btn'; accept.textContent='Подтвердить';
  accept.onclick = ()=> updateOpStatus(op.key, 'confirmed');
  const reject = document.createElement('button'); reject.className='btn'; reject.textContent='Отклонить';
  reject.onclick = ()=> updateOpStatus(op.key, 'cancelled');
  actions.appendChild(viewBtn); actions.appendChild(accept); actions.appendChild(reject);
  card.appendChild(actions);

  return card;
}

function renderList(){
  listEl.innerHTML = '';
  const all = Array.from(ops.values());
  const filtered = boundTerminal ? all.filter(o => String(o.terminalId) === String(boundTerminal)) : all;
  // order: pendings first
  const pend = filtered.filter(o=>o.status === 'pending');
  const others = filtered.filter(o=>o.status !== 'pending');
  const ordered = [...pend, ...others];

  if(boundTerminal === null){
    emptyNotice.innerHTML = `<div class="empty">Привяжите терминал, чтобы управлять им.<br><small class="muted">Введите ID терминала и нажмите «Привязать»</small></div>`;
    newCountEl.textContent = 'Новых: 0';
    return;
  }

  if(ordered.length === 0){
    emptyNotice.innerHTML = `<div class="empty">Список пуст.<br><small class="muted">Возможно, принятые запросы отсутствуют для терминала <strong>${boundTerminal}</strong><br>Проверьте, правильно ли введён ID.</small></div>`;
    newCountEl.textContent = 'Новых: 0';
    return;
  } else {
    emptyNotice.innerHTML = '';
  }

  for(const op of ordered){
    listEl.appendChild(buildCard(op));
  }
  newCountEl.textContent = 'Новых: ' + pend.length;
}

function showModal(op){
  const root = document.getElementById('modalRoot'); root.innerHTML = ''; root.style.display = 'block';
  const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div'); modal.className = 'modal';
  const h = document.createElement('h2'); h.textContent = `Оплата: ${formatMoney(op.amount || 0)}`;
  const meta = document.createElement('div'); meta.className = 'meta';
  meta.textContent = `Терминал: ${op.terminalId || '—'} • Штук: ${op.totalCount || 0} • Время: ${formatTime(op.time || Date.now())}`;
  const pos = document.createElement('div'); pos.className = 'positions';
  if(op.items && op.items.length){
    pos.innerHTML = op.items.map(i => {
      const price = (i.price || 0)*(i.count || 1);
      return `${i.name} x${i.count} — ${price.toFixed(2)} ₽`;
    }).join('<br>');
  } else pos.textContent = 'Нет позиций';

  const actions = document.createElement('div'); actions.className = 'modal-actions';
  const btnDecline = document.createElement('button'); btnDecline.className = 'btn'; btnDecline.textContent = 'Отклонить';
  btnDecline.onclick = ()=> { updateOpStatus(op.key, 'cancelled'); closeModal(); };
  const btnAccept = document.createElement('button'); btnAccept.className = 'btn'; btnAccept.textContent = 'Подтвердить';
  btnAccept.onclick = ()=> { updateOpStatus(op.key, 'confirmed'); closeModal(); };
  const btnClose = document.createElement('button'); btnClose.className = 'btn secondary'; btnClose.textContent = 'Закрыть';
  btnClose.onclick = closeModal;
  actions.appendChild(btnDecline); actions.appendChild(btnAccept); actions.appendChild(btnClose);

  modal.appendChild(h); modal.appendChild(meta); modal.appendChild(pos); modal.appendChild(actions);
  backdrop.appendChild(modal);
  root.appendChild(backdrop);

  function closeModal(){ root.innerHTML = ''; root.style.display='none'; }
}

function updateOpStatus(key, newStatus){
  const handledBy = 'kassir@web';
  const handledAt = Date.now();
  if(!dbRef) { showToast('Нет подключения к БД'); return; }
  dbRef.child(key).update({ status: newStatus, handledBy, handledAt })
    .then(()=> showToast('Статус обновлён: ' + newStatus))
    .catch(err=> { console.error('Ошибка обновления:', err); showToast('Ошибка при обновлении'); });
}

function snapshotToOp(snapshot){
  const val = snapshot.val() || {};
  const key = snapshot.key;
  const status = val.status || 'pending';
  const terminalId = val.terminalId || val.term || null;
  const amount = (typeof val.amount === 'number') ? val.amount : (typeof val.total === 'number' ? val.total : 0);
  const totalCount = val.totalCount || 0;
  const time = val.time || Date.now();
  const itemsRaw = val.items || {};
  const items = [];
  try {
    if(Array.isArray(itemsRaw)){
      itemsRaw.forEach(it => { if(!it) return; items.push({ id: it.id||null, name: it.name||'item', price: parseFloat(it.price||0), count: parseInt(it.count||1) }); });
    } else {
      Object.keys(itemsRaw).forEach(k=>{
        const it = itemsRaw[k];
        items.push({
          id: it && it.id ? it.id : k,
          name: (it && it.name) ? it.name : 'item',
          price: parseFloat((it && it.price) || 0),
          count: parseInt((it && it.count) || 1)
        });
      });
    }
  } catch(e){
    console.warn('Ошибка разбора items:', e);
  }
  return { key, status, terminalId, amount, totalCount, items, time };
}

function showToast(msg){
  console.log('TOAST:', msg);
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed'; t.style.bottom='16px'; t.style.left='50%';
  t.style.transform='translateX(-50%)'; t.style.background='#222'; t.style.color='#fff';
  t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex=9999;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 2500);
}

// initialize Firebase and listeners
(function init(){
  // load bound terminal from storage
  const saved = loadBoundTerminal();
  if(saved) {
    boundTerminal = saved;
    terminalInput.value = boundTerminal;
  } else {
    boundTerminal = null;
  }

  if (typeof firebase === 'undefined' || !firebase || !firebase.initializeApp) {
    serverStatusEl.textContent = 'Firebase SDK не загружен';
    console.error('Firebase SDK (compat) не найден. Убедитесь, что скрипты подключены.');
    // still allow UI: show message about missing SDK
    emptyNotice.innerHTML = `<div class="empty">Firebase SDK не загружен. Проверьте подключение скриптов.</div>`;
    return;
  }

  try {
    firebase.initializeApp(firebaseConfig);
    dbRef = firebase.database().ref('paymentAttempts');
    serverStatusEl.textContent = 'подключение...';

    // connected state
    firebase.database().ref('.info/connected').on('value', snap => {
      const connected = snap.val() === true;
      serverStatusEl.textContent = connected ? 'онлайн' : 'оффлайн';
    });

    // listeners
    dbRef.on('child_added', snapshot => {
      const op = snapshotToOp(snapshot);
      ops.set(op.key, op);
      renderList();
      if(boundTerminal && String(op.terminalId) === String(boundTerminal) && op.status === 'pending'){
        showToast('Новая ожидающая оплата: ' + formatMoney(op.amount));
      }
    });

    dbRef.on('child_changed', snapshot => {
      const op = snapshotToOp(snapshot);
      ops.set(op.key, op);
      renderList();
      if(boundTerminal && String(op.terminalId) === String(boundTerminal) && op.status === 'pending'){
        showToast('Обновлён ожидающий платёж: ' + formatMoney(op.amount));
      }
    });

    dbRef.on('child_removed', snapshot => {
      const key = snapshot.key;
      ops.delete(key);
      renderList();
    });

    // initial render
    renderList();

  } catch (err) {
    console.error('Ошибка инициализации Firebase:', err);
    serverStatusEl.textContent = 'ошибка инициализации';
    emptyNotice.innerHTML = `<div class="empty">Ошибка инициализации Firebase. Проверьте конфиг в коде.</div>`;
  }
})();

// helpers for localStorage functions declared earlier
function sanitizeTerminalInput(v){
  if(!v) return null;
  const digits = v.toString().replace(/\D+/g,'');
  return digits || null;
}
function loadBoundTerminal(){
  const v = localStorage.getItem(LS_KEY);
  return sanitizeTerminalInput(v);
}
function saveBoundTerminal(id){
  if(id) localStorage.setItem(LS_KEY, id); else localStorage.removeItem(LS_KEY);
}
function setBoundTerminal(id){
  boundTerminal = id;
  if(boundTerminal){
    terminalInput.value = boundTerminal;
    saveBoundTerminal(boundTerminal);
    showToast('Терминал привязан: ' + boundTerminal);
  } else {
    terminalInput.value = '';
    saveBoundTerminal(null);
    showToast('Терминал отвязан');
  }
  renderList();
}

// Ensure bind/unbind keyboard "Enter" behavior
terminalInput.addEventListener('keypress', (e) => {
  if(e.key === 'Enter'){
    btnBind.click();
  }
});

// expose for debug
window._fk = { ops, dbRef, setBoundTerminal, loadBoundTerminal };

</script>
</body>
</html>
